<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Conteúdo | ClickUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #E2E8F0; overflow-x: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { min-height: 140px; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #1a202c; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #01FEF2; }
        .title-cyan { color: #01FEF2; text-shadow: 0 0 8px rgba(1, 254, 242, 0.4); }
        .hidden { display: none; }
        .feed-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .feed-preview-item { aspect-ratio: 1 / 1; background-size: cover; background-position: center; }

        /* Estilos customizados para o Tom Select */
        .ts-control {
            background-color: #1A202C !important;
            border-color: #4A5568 !important;
            border-radius: 0.5rem !important;
        }
        .ts-dropdown {
            background-color: #1A202C !important;
            border-color: #4A5568 !important;
        }
        .ts-dropdown .option {
            padding: 8px 12px;
        }
        .ts-dropdown .option:hover {
            background-color: #01FEF220;
        }
        .ts-item, .ts-control .ts-input {
            color: #E2E8F0 !important;
        }
        .ts-item {
            background-color: #01FEF2 !important;
            color: #000 !important;
            border-radius: 0.25rem;
            display: inline-flex;
            align-items: center;
        }
        .ts-item.active {
            background-color: #01FEF2 !important;
        }
        .ts-item .remove-button {
            color: #000 !important;
            text-decoration: none;
            margin-left: 6px;
        }
        .ts-item .remove-button:hover {
            background: none !important;
        }
        .assignee-item-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .assignee-option-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
        }
    </style>
</head>
<body class="antialiased">

    <div id="auth-view" class="min-h-screen flex flex-col items-center justify-center bg-black p-4">
        <img src="https://i.imgur.com/tbNCfeI.png" alt="Logo da Empresa" class="h-20 mb-8">
        <div id="login-container" class="w-full max-w-sm">
            <div class="bg-gray-900/70 border border-gray-700/50 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-2xl font-bold text-center title-cyan mb-6">Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input type="email" id="login-email" name="email" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                        <input type="password" id="login-password" name="password" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-lg bg-cyan-500 text-black font-bold hover:bg-cyan-400 transition">Entrar</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Não tem uma conta? <button id="show-signup" class="font-semibold text-cyan-400 hover:underline">Cadastre-se</button>
                </p>
            </div>
        </div>
        <div id="signup-container" class="w-full max-w-sm hidden">
            <div class="bg-gray-900/70 border border-gray-700/50 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-2xl font-bold text-center title-cyan mb-6">Criar Conta</h2>
                <form id="signup-form">
                     <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input type="email" id="signup-email" name="email" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                        <input type="password" id="signup-password" name="password" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-lg bg-cyan-500 text-black font-bold hover:bg-cyan-400 transition">Criar Conta</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Já tem uma conta? <button id="show-login" class="font-semibold text-cyan-400 hover:underline">Faça Login</button>
                </p>
            </div>
        </div>
        <p id="auth-error" class="mt-4 text-red-400 text-sm text-center h-4"></p>
    </div>

    <div id="calendar-view" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
                <img src="https://i.imgur.com/tbNCfeI.png" alt="Logo da Empresa" class="h-16" onerror="this.onerror=null;this.src='https://placehold.co/200x64/000000/01FEF2?text=Sua+Logo';">
                <h1 class="text-2xl sm:text-3xl font-black uppercase tracking-wider title-cyan" id="month-year"></h1>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                         <p id="user-email" class="text-sm text-gray-300"></p>
                         <button id="logout-btn" class="text-xs text-cyan-400 hover:underline">Sair</button>
                    </div>
                    <button id="prev-month" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-cyan-400 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <button id="next-month" class="p-2 rounded-full bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-cyan-400 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                     <button id="today-btn" class="px-4 py-2 rounded-lg bg-cyan-500 text-black font-bold shadow-lg shadow-cyan-500/20 hover:bg-cyan-400 transition-colors duration-200">Hoje</button>
                </div>
            </header>
            
            <main class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <div class="xl:col-span-2">
                    <div class="bg-gray-900/70 rounded-2xl shadow-lg border border-gray-700/50 p-4 backdrop-blur-sm">
                        <div class="calendar-grid mb-2 text-center font-bold text-gray-400 uppercase text-xs">
                            <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                        </div>
                        <div id="calendar-body" class="calendar-grid"></div>
                    </div>
                </div>
                <div class="xl:col-span-1">
                    <div id="feed-preview-container" class="bg-gray-900/70 rounded-2xl p-6 shadow-lg border border-gray-700/50">
                        <h3 class="text-lg font-bold title-cyan mb-4 text-center">Prévia do Feed (Status: org.drive)</h3>
                        <div id="feed-preview-grid" class="feed-preview-grid bg-gray-800 rounded-lg p-1"></div>
                         <p id="feed-loader" class="text-center text-gray-400 mt-4 hidden">Carregando prévia...</p>
                         <p id="feed-empty" class="text-center text-gray-500 mt-4 text-sm hidden">Nenhum post com status "org.drive" e anexo de imagem encontrado para este mês.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="post-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 border border-cyan-500/30 rounded-2xl shadow-2xl shadow-cyan-500/10 p-6 sm:p-8 w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0 overflow-y-auto max-h-[90vh]">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 title-cyan">Adicionar Tarefa</h2>
            <form id="post-form">
                <input type="hidden" id="post-id">
                <input type="hidden" id="post-date">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div>
                        <div class="mb-4">
                            <label for="post-title" class="block text-sm font-medium text-gray-300 mb-2">Título da Tarefa</label>
                            <input type="text" id="post-title" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div class="mb-4">
                            <label for="post-description" class="block text-sm font-medium text-gray-300 mb-2">Descrição</label>
                            <textarea id="post-description" rows="4" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Anexo de Referência (Imagem)</label>
                            <input type="file" id="post-attachment" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500/80 file:text-black hover:file:bg-cyan-500">
                        </div>
                    </div>
                    <div>
                        <div class="mb-4">
                            <label for="post-status" class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                            <select id="post-status"></select>
                        </div>
                        <div class="mb-4">
                            <label for="post-assignees" class="block text-sm font-medium text-gray-300 mb-2">Responsáveis</label>
                            <select id="post-assignees" multiple></select>
                        </div>
                        <div class="mb-4">
                            <label for="post-priority" class="block text-sm font-medium text-gray-300 mb-2">Prioridade</label>
                            <select id="post-priority">
                                <option value="1">Urgente</option>
                                <option value="2">Alta</option>
                                <option value="3" selected>Normal</option>
                                <option value="4">Baixa</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="post-tags" class="block text-sm font-medium text-gray-300 mb-2">Etiquetas</label>
                            <select id="post-tags" multiple></select>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-8">
                    <button type="button" id="delete-post-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition hidden">Excluir</button>
                    <div class="flex-grow"></div>
                    <button type="button" id="cancel-btn" class="px-4 py-2 mr-2 rounded-lg bg-gray-700 text-gray-200 font-semibold hover:bg-gray-600 transition">Cancelar</button>
                    <button type="submit" id="save-btn" class="px-4 py-2 rounded-lg bg-cyan-500 text-black font-bold hover:bg-cyan-400 transition">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // --- Supabase Configuration ---
        const supabaseUrl = 'https://llbhyuyuopipzvomfmaw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsYmh5dXl1b3BpcHp2b21mbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMzAyMDUsImV4cCI6MjA2ODcwNjIwNX0.GsBaJXL_RhM4ZKUNYAxQBgCCfgeb8I6ko9sMPQE7k4g';
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // --- ClickUp Configuration ---
        const CLICKUP_CONFIG = {
            APP_TAG: 'calendario-app',
            LIST_ID: '901110936571',
            STATUS_ORG_DRIVE: 'sc901110936571_ALwKEg0e',
            STATUSES: [
                { id: "sc901110936571_Rma95Ekh", name: "redação", color: "#87909e" }, { id: "sc901110936571_Aq3F2oot", name: "pendente", color: "#87909e" },
                { id: "sc901110936571_xt2JAo7W", name: "em andamento", color: "#1090e0" }, { id: "sc901110936571_98o7uPbP", name: "p/ aprovação", color: "#f8ae00" },
                { id: "sc901110936571_EuMOoSFS", name: "alteração", color: "#e16b16" }, { id: "sc901110936571_4Wjd1tgr", name: "reformulando", color: "#d33d44" },
                { id: "sc901110936571_m4SxQrUB", name: "enviado", color: "#41e053" }, { id: "sc901110936571_ALwKEg0e", name: "org.drive", color: "#f8ae00" },
                { id: "sc901110936571_5hw48aZv", name: "agendado", color: "#b660e0" }, { id: "sc901110936571_n58C4vnk", name: "demanda finalizada", color: "#008844" },
            ],
            // ATUALIZADO: Adicionamos a propriedade 'avatar' com a URL da foto de perfil
            USERS: [
                { id: 43026696, name: "Walber Design", avatar: "https://attachments.clickup.com/profilePictures/43026696_wNe.jpg" },
                { id: 49057040, name: "Vinícius Lopes", avatar: "https://attachments.clickup.com/profilePictures/49057040_IlI.jpg" },
                { id: 55008762, name: "Matheus Sanches", avatar: "https://attachments.clickup.com/profilePictures/55008762_OnT.jpg" },
                { id: 55092698, name: "Jhowcopy", avatar: null },
                { id: 81379463, name: "Daniel Fernandes", avatar: "https://attachments.clickup.com/profilePictures/81379463_Zzi.jpg" },
                { id: 81379465, name: "Eduardo Pozza", avatar: "https://attachments.clickup.com/profilePictures/81379465_5dS.jpg" },
                { id: 81379468, name: "Iago Lacerda", avatar: "https://attachments.clickup.com/profilePictures/81379468_TTC.jpg" },
                { id: 81379471, name: "Khauan Cardoso", avatar: null },
                { id: 81379472, name: "Matheus Azevedo", avatar: null },
                { id: 81379473, name: "Matheus Sousa Muniz", avatar: "https://attachments.clickup.com/profilePictures/81379473_ALT.jpg" },
                { id: 81379477, name: "Vinicius Dala Stella", avatar: "https://attachments.clickup.com/profilePictures/81379477_8zw.jpg" },
                { id: 81562124, name: "Douglas Martins", avatar: "https://attachments.clickup.com/profilePictures/81562124_2Z3.jpg" },
                { id: 81565786, name: "Lidia Sena", avatar: "https://attachments.clickup.com/profilePictures/81565786_lMu.jpg" },
                { id: 81574217, name: "Raicon Look", avatar: "https://attachments.clickup.com/profilePictures/81574217_D9S.jpg" },
                { id: 90763054, name: "João Cláudio", avatar: "https://attachments.clickup.com/profilePictures/90763054_GfU.jpg" },
                { id: 188529441, name: "DayGraph", avatar: "https://attachments.clickup.com/profilePictures/188529441_WRr.jpg" },
                { id: 194482086, name: "Lucas Rodrigues", avatar: null },
                { id: 212437679, name: "Videomaker do Futuro", avatar: "https://attachments.clickup.com/profilePictures/212437679_Uyv.jpg" },
                { id: 212521614, name: "Vinícius Lopes", avatar: "https://attachments.clickup.com/profilePictures/212521614_8Lg.jpg" }
            ],
            TAGS: [
                { name: "história", color: "#e5484d" }, { name: "realizada", color: "#3E63DD" }, { name: "movimento", color: "#0091FF" },
                { name: "brincadeiras", color: "#e93d82" }, { name: "agendada", color: "#f76808" }, { name: "site", color: "#248F7D" },
                { name: "esporte", color: "#AB4ABA" }, { name: "destaques", color: "#A18072" }, { name: "miniatura", color: "#23CB27" },
                { name: "feed", color: "#6E56CF" }, { name: "telegrama", color: "#ffc53d" }, { name: "premiação", color: "#ffc53d" },
                { name: "diário", color: "#6E56CF" }, { name: "institucional", color: "#00fff6" }, { name: "animação", color: "#000" },
                { name: "casa", color: "#2F8960" }, { name: "vfx", color: "#2A7552" }, { name: "youtube", color: "#12A594" }
            ]
        };

        // --- Global State ---
        let currentUser = null;
        let currentDate = new Date();
        let tasks = [];
        let currentEditingTaskId = null;
        let tomSelectInstances = {};

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view'); const calendarView = document.getElementById('calendar-view'); const loginContainer = document.getElementById('login-container'); const signupContainer = document.getElementById('signup-container'); const loginForm = document.getElementById('login-form'); const signupForm = document.getElementById('signup-form'); const authError = document.getElementById('auth-error'); const userEmailEl = document.getElementById('user-email'); const monthYearEl = document.getElementById('month-year'); const calendarBodyEl = document.getElementById('calendar-body'); const modal = document.getElementById('post-modal'); const modalTitle = document.getElementById('modal-title'); const postForm = document.getElementById('post-form'); const postIdInput = document.getElementById('post-id'); const postDateInput = document.getElementById('post-date'); const postTitleInput = document.getElementById('post-title'); const postDescriptionInput = document.getElementById('post-description'); const postAttachmentInput = document.getElementById('post-attachment'); const deleteBtn = document.getElementById('delete-post-btn'); const saveBtn = document.getElementById('save-btn'); const feedPreviewGrid = document.getElementById('feed-preview-grid'); const feedLoader = document.getElementById('feed-loader'); const feedEmpty = document.getElementById('feed-empty');

        // --- Auth & App Initialization ---
        supabase.auth.onAuthStateChange((event, session) => { if (session && session.user) { currentUser = session.user; userEmailEl.textContent = currentUser.email; authView.classList.add('hidden'); calendarView.classList.remove('hidden'); initializeApp(); } else { currentUser = null; authView.classList.remove('hidden'); calendarView.classList.add('hidden'); } });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); authError.textContent = ''; const btn = loginForm.querySelector('button[type=submit]'); btn.disabled = true; btn.textContent = 'Aguarde...'; try { const { error } = await supabase.auth.signInWithPassword({ email: loginForm.email.value, password: loginForm.password.value }); if (error) authError.textContent = 'Email ou senha inválidos.'; } finally { btn.disabled = false; btn.textContent = 'Entrar'; } });
        signupForm.addEventListener('submit', async (e) => { e.preventDefault(); authError.textContent = ''; const btn = signupForm.querySelector('button[type=submit]'); btn.disabled = true; btn.textContent = 'Aguarde...'; try { const { error } = await supabase.auth.signUp({ email: signupForm.email.value, password: signupForm.password.value }); if (error) { authError.textContent = error.message; } else { authError.textContent = 'Verifique seu email para confirmar a conta!'; } } finally { btn.disabled = false; btn.textContent = 'Criar Conta'; } });
        document.getElementById('logout-btn').addEventListener('click', () => supabase.auth.signOut()); document.getElementById('show-signup').addEventListener('click', () => { loginContainer.classList.add('hidden'); signupContainer.classList.remove('hidden'); }); document.getElementById('show-login').addEventListener('click', () => { signupContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); });

        async function initializeApp() {
            if (!currentUser) return;
            initializeTomSelects();
            await fetchAndRenderAll();
        }

        async function fetchAndRenderAll() { tasks = await getClickUpTasks(); renderCalendar(); renderFeedPreview(); }

        // --- Tom Select Initialization ---
        function initializeTomSelects() {
            // Status Select
            tomSelectInstances.status = new TomSelect('#post-status', {
                options: CLICKUP_CONFIG.STATUSES.map(s => ({ value: s.id, text: s.name, color: s.color })),
                render: {
                    option: function(data, escape) {
                        return `<div><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${escape(data.color)}; margin-right: 8px;"></span><span>${escape(data.text)}</span></div>`;
                    },
                    item: function(data, escape) {
                        return `<div><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${escape(data.color)}; margin-right: 8px;"></span>${escape(data.text)}</div>`;
                    }
                }
            });

            // Assignees Select
            tomSelectInstances.assignees = new TomSelect('#post-assignees', {
                options: CLICKUP_CONFIG.USERS.map(u => ({ value: u.id, text: u.name, avatar: u.avatar })),
                render: {
                    option: function(data, escape) {
                        const avatarUrl = data.avatar || `https://ui-avatars.com/api/?name=${escape(data.text)}&background=random`;
                        return `<div class="flex items-center"><img class="assignee-option-avatar" src="${avatarUrl}" alt=""><span>${escape(data.text)}</span></div>`;
                    },
                    item: function(data, escape) {
                        const avatarUrl = data.avatar || `https://ui-avatars.com/api/?name=${escape(data.text)}&background=random`;
                        return `<div class="flex items-center"><img class="assignee-item-avatar" src="${avatarUrl}" alt=""><span>${escape(data.text)}</span></div>`;
                    }
                }
            });

            // Tags Select
            tomSelectInstances.tags = new TomSelect('#post-tags', {
                options: CLICKUP_CONFIG.TAGS.map(t => ({ value: t.name, text: t.name, color: t.color })),
                create: true,
                plugins: ['remove_button'],
                render: {
                    option: function(data, escape) {
                        const color = data.color || '#718096';
                        return `<div><span style="display: inline-block; padding: 2px 8px; border-radius: 4px; background-color: ${color}40; color: ${color}; font-weight: 500;">${escape(data.text)}</span></div>`;
                    },
                    item: function(data, escape) {
                        const color = data.color || '#718096';
                         return `<div class="ts-item" style="background-color: ${color} !important; color: #fff !important; text-shadow: 0 0 5px rgba(0,0,0,0.5);">${escape(data.text)}</div>`;
                    }
                }
            });
        }
        
        // --- ClickUp API & Data Handling ---
        async function clickupFetch(endpoint, options = {}) {
            const response = await fetch('/api/clickup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ endpoint, method: options.method || 'GET', body: options.body || null }) });
            if (!response.ok) { const err = await response.json(); throw new Error(err.err || 'Erro desconhecido'); }
            return response.json();
        }
        async function uploadAttachmentToTask(taskId, file) {
            const formData = new FormData();
            formData.append('taskId', taskId);
            formData.append('attachment', file);
            const response = await fetch('/api/uploadAttachment', { method: 'POST', body: formData });
            if (!response.ok) { const err = await response.json(); throw new Error(err.err || 'Erro no upload'); }
            return response.json();
        }
        async function getClickUpTasks() {
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getTime();
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getTime();
            const endpoint = `list/${CLICKUP_CONFIG.LIST_ID}/task?subtasks=true&due_date_gt=${firstDay}&due_date_lt=${lastDay}&tags[]=${CLICKUP_CONFIG.APP_TAG}`;
            try { const data = await clickupFetch(endpoint); return data.tasks || []; } catch (error) { alert(`Erro ao buscar tarefas do ClickUp: ${error.message}`); return []; }
        }
        async function getSingleClickUpTask(taskId) { try { return await clickupFetch(`task/${taskId}?subtasks=true`); } catch (error) { console.error(`Failed to fetch task ${taskId}:`, error); return null; } }
        async function createClickUpTask(taskData) { return clickupFetch(`list/${CLICKUP_CONFIG.LIST_ID}/task`, { method: 'POST', body: taskData }); }
        async function updateClickUpTask(taskId, taskData) { return clickupFetch(`task/${taskId}`, { method: 'PUT', body: taskData }); }

        // --- Calendar & UI Rendering ---
        function renderCalendar() {
            calendarBodyEl.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearEl.textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) calendarBodyEl.appendChild(createDayCell(null));
            for (let day = 1; day <= daysInMonth; day++) calendarBodyEl.appendChild(createDayCell(day));
        }
        function createDayCell(day) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day border-t border-l border-gray-800 p-1.5 flex flex-col relative group';
            if (!day) { dayCell.classList.add('bg-black/20'); return dayCell; }
            const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayCell.dataset.date = dateStr;
            const dayNumber = document.createElement('span');
            dayNumber.textContent = day;
            dayNumber.className = 'text-xs sm:text-sm font-medium self-end text-gray-400';
            const today = new Date();
            if (day === today.getDate() && currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear()) {
                dayNumber.className = 'bg-cyan-500 text-black rounded-full h-6 w-6 flex items-center justify-center font-bold text-sm';
            }
            const postsContainer = document.createElement('div');
            postsContainer.className = 'mt-1 flex-grow overflow-y-auto space-y-1';
            const dayTasks = tasks.filter(task => task.due_date && new Date(parseInt(task.due_date)).toISOString().startsWith(dateStr));
            dayTasks.forEach(task => postsContainer.appendChild(createTaskElement(task)));
            const addBtn = document.createElement('button');
            addBtn.textContent = '+';
            addBtn.className = 'absolute top-1 left-1 h-6 w-6 flex items-center justify-center rounded-full bg-gray-700 hover:bg-cyan-500 hover:text-black text-gray-400 font-bold opacity-0 group-hover:opacity-100 transition-all duration-200';
            addBtn.addEventListener('click', e => { e.stopPropagation(); openModal(dateStr); });
            dayCell.appendChild(dayNumber);
            dayCell.appendChild(postsContainer);
            dayCell.appendChild(addBtn);
            return dayCell;
        }
        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            const statusColor = CLICKUP_CONFIG.STATUSES.find(s => s.id === task.status.id)?.color || '#4a5568';
            taskEl.className = `p-1.5 rounded-md text-xs cursor-pointer border-l-4 transition-transform hover:scale-105 hover:z-10`;
            taskEl.style.borderColor = statusColor;
            taskEl.style.backgroundColor = `${statusColor}20`;
            taskEl.draggable = true;
            taskEl.dataset.taskId = task.id;
            taskEl.innerHTML = `<p class="font-semibold truncate" style="color: ${statusColor}">${task.name}</p>`;
            taskEl.addEventListener('click', () => openModal(null, task.id));
            return taskEl;
        }
        function renderFeedPreview() {
            feedPreviewGrid.innerHTML = '';
            feedLoader.classList.remove('hidden');
            feedEmpty.classList.add('hidden');
            const feedTasks = tasks.filter(task => task.status?.id === CLICKUP_CONFIG.STATUS_ORG_DRIVE && task.attachments?.length > 0)
                                 .sort((a, b) => parseInt(b.date_updated) - parseInt(a.date_updated));

            if (feedTasks.length === 0) {
                feedLoader.classList.add('hidden');
                feedEmpty.classList.remove('hidden');
                return;
            }
            feedTasks.forEach(task => {
                const imageAttachments = task.attachments.filter(att => att.extension.match(/jpe?g|png|gif|webp/i));
                if (imageAttachments.length > 0) {
                     const latestAttachment = imageAttachments.sort((a,b) => b.date - a.date)[0];
                     const item = document.createElement('div');
                     item.className = 'feed-preview-item rounded';
                     item.style.backgroundImage = `url(${latestAttachment.url})`;
                     feedPreviewGrid.appendChild(item);
                }
            });
            feedLoader.classList.add('hidden');
            if (feedPreviewGrid.children.length === 0) {
                feedEmpty.classList.remove('hidden');
            }
        }
        
        // --- Modal & Form Logic ---
        async function openModal(dateStr, taskId = null) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('div > div').classList.remove('scale-95', 'opacity-0'), 10);
            postForm.reset();

            // Limpa e reseta os selects do Tom Select
            Object.values(tomSelectInstances).forEach(instance => instance.clear());

            if (taskId) {
                currentEditingTaskId = taskId;
                modalTitle.textContent = 'Editar Tarefa';
                deleteBtn.classList.remove('hidden');
                
                const task = await getSingleClickUpTask(taskId);
                if (!task) { closeModal(); return; }

                postTitleInput.value = task.name;
                postDescriptionInput.value = task.description || '';
                tomSelectInstances.status.setValue(task.status.id);
                tomSelectInstances.assignees.setValue(task.assignees.map(a => a.id));
                tomSelectInstances.tags.setValue(task.tags.map(t => t.name));
                // Note: prioridade e data ainda usam campos normais
                document.getElementById('post-priority').value = task.priority?.priority || '3';
                postDateInput.value = new Date(parseInt(task.due_date)).toISOString().split('T')[0];
            } else {
                currentEditingTaskId = null;
                modalTitle.textContent = 'Adicionar Tarefa';
                deleteBtn.classList.add('hidden');
                postDateInput.value = dateStr;
                tomSelectInstances.status.setValue(CLICKUP_CONFIG.STATUSES.find(s => s.name === 'redação').id);
            }
        }
        function closeModal() {
            modal.querySelector('div > div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        async function handleFormSubmit(e) {
            e.preventDefault();
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';
            
            // Pega os valores dos campos do Tom Select
            const assignees = tomSelectInstances.assignees.getValue();
            const tags = tomSelectInstances.tags.getValue();
            if (!tags.includes(CLICKUP_CONFIG.APP_TAG)) {
                tags.push(CLICKUP_CONFIG.APP_TAG);
            }

            const taskData = {
                name: postTitleInput.value,
                description: postDescriptionInput.value,
                status: tomSelectInstances.status.getValue(),
                priority: parseInt(document.getElementById('post-priority').value),
                assignees: assignees,
                tags: tags,
                due_date: new Date(postDateInput.value + 'T12:00:00Z').getTime(),
            };
            try {
                let savedTask;
                if (currentEditingTaskId) {
                    await updateClickUpTask(currentEditingTaskId, taskData);
                    savedTask = { id: currentEditingTaskId };
                } else {
                    savedTask = await createClickUpTask(taskData);
                }
                const attachmentFile = postAttachmentInput.files[0];
                if (attachmentFile && savedTask.id) {
                    saveBtn.textContent = 'Enviando anexo...';
                    await uploadAttachmentToTask(savedTask.id, attachmentFile);
                }
                closeModal();
                await fetchAndRenderAll();
            } catch (error) {
                console.error('Error saving task:', error);
                alert(`Falha ao salvar a tarefa: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar Tarefa';
            }
        }
        
        // --- Event Listeners ---
        document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); fetchAndRenderAll(); });
        document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); fetchAndRenderAll(); });
        document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); fetchAndRenderAll(); });
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        postForm.addEventListener('submit', handleFormSubmit);

    </script>
</body>
</html>