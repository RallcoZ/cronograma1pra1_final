<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Conteúdo | ClickUp</title>

    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Cronograma" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700;900&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    
    <style>
        :root {
            --color-bg-darkest: #05172d;
            --color-bg-dark: #09293d;
            --color-accent-medium: #065359;
            --color-accent-bright: #00fdf1;
            --color-text-primary: #ffffff;
            --font-heading: 'Exo 2', sans-serif;
            --font-body: 'Montserrat', sans-serif;
        }
        body { 
            font-family: var(--font-body); 
            background-color: var(--color-bg-darkest); 
            color: var(--color-text-primary); 
            overflow-x: hidden; 
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { min-height: 140px; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--color-accent-medium); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-accent-bright); }
        
        .title-highlight { 
            font-family: var(--font-heading);
            color: var(--color-accent-bright); 
            text-shadow: 0 0 8px rgba(0, 253, 241, 0.4);
        }
        .hidden { display: none; }
        .feed-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .feed-preview-item { aspect-ratio: 1 / 1; background-size: cover; background-position: center; }

        #task-popover {
            position: fixed;
            width: 300px;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-accent-medium);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
        }
        #task-popover.visible {
            opacity: 1;
            transform: scale(1);
        }

        .ts-control {
            background-color: var(--color-bg-dark) !important;
            border: 1px solid var(--color-accent-medium) !important;
            border-radius: 0.5rem !important;
            padding: 0.5rem 0.75rem !important;
            font-family: var(--font-body);
        }
        .ts-control:hover { border-color: var(--color-accent-bright) !important; }
        .ts-control.focus {
             border-color: var(--color-accent-bright) !important;
             box-shadow: 0 0 0 0.2rem rgba(0, 253, 241, 0.25) !important;
        }
        .ts-dropdown {
            background-color: var(--color-bg-dark) !important;
            border-color: var(--color-accent-medium) !important;
        }
        .ts-dropdown .option { padding: 8px 12px; }
        .ts-dropdown .option:hover, .ts-dropdown .active {
            background-color: rgba(0, 253, 241, 0.1) !important;
        }
        .ts-control .item, .ts-control .ts-input {
            color: var(--color-text-primary) !important;
            font-family: var(--font-body);
        }
        .ts-item {
            background-color: var(--color-accent-medium) !important;
            color: var(--color-accent-bright) !important;
            border-radius: 0.25rem;
            display: inline-flex;
            align-items: center;
        }
        .ts-item .remove-button {
            color: var(--color-accent-bright) !important;
            text-decoration: none;
            margin-left: 6px;
        }
        .assignee-item-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
        .assignee-option-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; }
    </style>
</head>
<body class="antialiased">

    <div id="auth-view" class="min-h-screen flex flex-col items-center justify-center p-4">
        <img src="https://i.imgur.com/MfrhXQA.png" alt="Logo da Empresa" class="h-20 mb-8">
        <div id="login-container" class="w-full max-w-sm">
            <div class="bg-[#09293d]/70 border border-[#065359]/50 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-2xl font-black text-center title-highlight mb-6 tracking-wider">LOGIN</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-white/80 mb-1">Email</label>
                        <input type="email" id="login-email" name="email" class="w-full px-3 py-2 bg-[#05172d] border border-[#065359] rounded-lg text-white focus:ring-2 focus:ring-[#00fdf1] focus:border-[#00fdf1] transition" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-white/80 mb-1">Senha</label>
                        <input type="password" id="login-password" name="password" class="w-full px-3 py-2 bg-[#05172d] border border-[#065359] rounded-lg text-white focus:ring-2 focus:ring-[#00fdf1] focus:border-[#00fdf1] transition" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-lg bg-[#00fdf1] text-[#05172d] font-bold hover:bg-opacity-80 transition">ENTRAR</button>
                </form>
                <p class="text-center text-sm text-white/60 mt-6">
                    Não tem uma conta? <button id="show-signup" class="font-semibold text-[#00fdf1] hover:underline">Cadastre-se</button>
                </p>
            </div>
        </div>
        <div id="signup-container" class="w-full max-w-sm hidden">
            <div class="bg-[#09293d]/70 border border-[#065359]/50 rounded-2xl p-8 shadow-2xl">
                <h2 class="text-2xl font-black text-center title-highlight mb-6 tracking-wider">CRIAR CONTA</h2>
                <form id="signup-form">
                     <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium text-white/80 mb-1">Email</label>
                        <input type="email" id="signup-email" name="email" class="w-full px-3 py-2 bg-[#05172d] border border-[#065359] rounded-lg text-white focus:ring-2 focus:ring-[#00fdf1] focus:border-[#00fdf1] transition" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium text-white/80 mb-1">Senha</label>
                        <input type="password" id="signup-password" name="password" class="w-full px-3 py-2 bg-[#05172d] border border-[#065359] rounded-lg text-white focus:ring-2 focus:ring-[#00fdf1] focus:border-[#00fdf1] transition" required>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 rounded-lg bg-[#00fdf1] text-[#05172d] font-bold hover:bg-opacity-80 transition">CRIAR CONTA</button>
                </form>
                <p class="text-center text-sm text-white/60 mt-6">
                    Já tem uma conta? <button id="show-login" class="font-semibold text-[#00fdf1] hover:underline">Faça Login</button>
                </p>
            </div>
        </div>
        <p id="auth-error" class="mt-4 text-red-400 text-sm text-center h-4"></p>
    </div>

    <div id="calendar-view" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
                <img src="https://i.imgur.com/MfrhXQA.png" alt="Logo da Empresa" class="h-16" onerror="this.onerror=null;this.src='https://placehold.co/200x64/05172d/00fdf1?text=Logo';">
                <h1 class="text-2xl sm:text-3xl font-black uppercase tracking-wider title-highlight" id="month-year"></h1>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                         <p id="user-email" class="text-sm text-white/80"></p>
                         <button id="logout-btn" class="text-xs text-[#00fdf1] hover:underline">Sair</button>
                    </div>
                    <button id="prev-month" class="p-2 rounded-full bg-[#09293d] hover:bg-[#065359] text-white/70 hover:text-[#00fdf1] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <button id="next-month" class="p-2 rounded-full bg-[#09293d] hover:bg-[#065359] text-white/70 hover:text-[#00fdf1] transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                     <button id="today-btn" class="px-4 py-2 rounded-lg bg-[#00fdf1] text-[#05172d] font-bold shadow-lg shadow-[#00fdf1]/20 hover:bg-opacity-80 transition-colors duration-200" style="font-family: var(--font-heading);">HOJE</button>
                </div>
            </header>
            
            <main class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <div class="xl:col-span-2">
                    <div class="bg-[#09293d]/70 rounded-2xl shadow-lg border border-[#065359]/50 p-4 backdrop-blur-sm">
                        <div class="calendar-grid mb-2 text-center font-bold text-white/60 uppercase text-xs" style="font-family: var(--font-heading);">
                            <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                        </div>
                        <div id="calendar-body" class="calendar-grid"></div>
                    </div>
                </div>
                <div class="xl:col-span-1">
                    <div id="feed-preview-container" class="bg-[#09293d]/70 rounded-2xl p-6 shadow-lg border border-[#065359]/50">
                        <h3 class="text-lg font-black title-highlight mb-4 text-center tracking-wider">PRÉVIA DO FEED</h3>
                        <div id="feed-preview-grid" class="feed-preview-grid bg-[#05172d] rounded-lg p-1"></div>
                         <p id="feed-loader" class="text-center text-white/60 mt-4 hidden">Carregando prévia...</p>
                         <p id="feed-empty" class="text-center text-white/50 mt-4 text-sm hidden">Nenhum post com status "org.drive" e anexo de imagem encontrado para este mês.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="post-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-[#09293d] border border-[#065359]/50 rounded-2xl shadow-2xl shadow-[#00fdf1]/10 p-6 sm:p-8 w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0 overflow-y-auto max-h-[90vh]">
            <h2 id="modal-title" class="text-2xl font-black mb-6 title-highlight tracking-wider">Adicionar Tarefa</h2>
            <form id="post-form">
                <input type="hidden" id="post-id">
                <input type="hidden" id="post-date">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div>
                        <div class="mb-4">
                            <label for="post-title" class="block text-sm font-semibold text-white/80 mb-2">Título da Tarefa</label>
                            <input type="text" id="post-title" class="w-full px-3 py-2 bg-[#05172d] border border-[#065359] rounded-lg text-white" required>
                        </div>
                        <div class="mb-4">
                            <label for="post-description" class="block text-sm font-semibold text-white/80 mb-2">Descrição</label>
                            <textarea id="post-description" rows="4" class="w-full px-3 py-2 bg-[#05172d] border border-[#065359] rounded-lg text-white"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-white/80 mb-2">Anexo de Referência (Opcional)</label>
                            <input type="file" id="post-attachment" accept="image/*" class="w-full text-sm text-white/60 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#00fdf1]/80 file:text-[#05172d] hover:file:bg-[#00fdf1]">
                        </div>
                        </div>
                    <div>
                        <div class="mb-4">
                            <label for="post-status" class="block text-sm font-semibold text-white/80 mb-2">Status</label>
                            <select id="post-status" placeholder="Selecione um status..."></select>
                        </div>
                        <div class="mb-4">
                            <label for="post-assignees" class="block text-sm font-semibold text-white/80 mb-2">Responsáveis</label>
                            <select id="post-assignees" multiple placeholder="Selecione os responsáveis..."></select>
                        </div>
                        <div class="mb-4">
                            <label for="post-priority" class="block text-sm font-semibold text-white/80 mb-2">Prioridade</label>
                            <select id="post-priority" placeholder="Selecione uma prioridade..."></select>
                        </div>
                        <div class="mb-4">
                            <label for="post-tags" class="block text-sm font-semibold text-white/80 mb-2">Etiquetas</label>
                            <select id="post-tags" multiple placeholder="Adicione ou crie etiquetas..."></select>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-8">
                    <button type="button" id="delete-post-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition hidden">Excluir</button>
                    <div class="flex-grow"></div>
                    <button type="button" id="cancel-btn" class="px-4 py-2 mr-2 rounded-lg bg-[#065359] text-white font-semibold hover:bg-opacity-80 transition">Cancelar</button>
                    <button type="submit" id="save-btn" class="px-4 py-2 rounded-lg bg-[#00fdf1] text-[#05172d] font-bold hover:bg-opacity-80 transition">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <div id="task-popover" class=""></div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // --- Configurações, Estado Global, Elementos DOM ---
        const supabaseUrl = 'https://llbhyuyuopipzvomfmaw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsYmh5dXl1b3BpcHp2b21mbWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMzAyMDUsImV4cCI6MjA2ODcwNjIwNX0.GsBaJXL_RhM4ZKUNYAxQBgCCfgeb8I6ko9sMPQE7k4g';
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        const CLICKUP_CONFIG = {
            APP_TAG: 'calendario-app',
            LIST_ID: '901110936571',
            STATUS_ORG_DRIVE: 'sc901110936571_ALwKEg0e',
            STATUSES: [
                { id: "sc901110936571_Rma95Ekh", name: "redação", color: "#87909e" }, { id: "sc901110936571_Aq3F2oot", name: "pendente", color: "#87909e" },
                { id: "sc901110936571_xt2JAo7W", name: "em andamento", color: "#1090e0" }, { id: "sc901110936571_98o7uPbP", name: "p/ aprovação", color: "#f8ae00" },
                { id: "sc901110936571_EuMOoSFS", name: "alteração", color: "#e16b16" }, { id: "sc901110936571_4Wjd1tgr", name: "reformulando", color: "#d33d44" },
                { id: "sc901110936571_m4SxQrUB", name: "enviado", color: "#41e053" }, { id: "sc901110936571_ALwKEg0e", name: "org.drive", color: "#f8ae00" },
                { id: "sc901110936571_5hw48aZv", name: "agendado", color: "#b660e0" }, { id: "sc901110936571_n58C4vnk", name: "demanda finalizada", color: "#008844" },
            ],
            USERS: [
                { id: 43026696, name: "Walber Design", avatar: "https://attachments.clickup.com/profilePictures/43026696_wNe.jpg" }, { id: 49057040, name: "Vinícius Lopes", avatar: "https://attachments.clickup.com/profilePictures/49057040_IlI.jpg" },
                { id: 55008762, name: "Matheus Sanches", avatar: "https://attachments.clickup.com/profilePictures/55008762_OnT.jpg" }, { id: 55092698, name: "Jhowcopy", avatar: null },
                { id: 81379463, name: "Daniel Fernandes", avatar: "https://attachments.clickup.com/profilePictures/81379463_Zzi.jpg" }, { id: 81379465, name: "Eduardo Pozza", avatar: "https://attachments.clickup.com/profilePictures/81379465_5dS.jpg" },
                { id: 81379468, name: "Iago Lacerda", avatar: "https://attachments.clickup.com/profilePictures/81379468_TTC.jpg" }, { id: 81379471, name: "Khauan Cardoso", avatar: null },
                { id: 81379472, name: "Matheus Azevedo", avatar: null }, { id: 81379473, name: "Matheus Sousa Muniz", avatar: "https://attachments.clickup.com/profilePictures/81379473_ALT.jpg" },
                { id: 81379477, name: "Vinicius Dala Stella", avatar: "https://attachments.clickup.com/profilePictures/81379477_8zw.jpg" }, { id: 81562124, name: "Douglas Martins", avatar: "https://attachments.clickup.com/profilePictures/81562124_2Z3.jpg" },
                { id: 81565786, name: "Lidia Sena", avatar: "https://attachments.clickup.com/profilePictures/81565786_lMu.jpg" }, { id: 81574217, name: "Raicon Look", avatar: "https://attachments.clickup.com/profilePictures/81574217_D9S.jpg" },
                { id: 90763054, name: "João Cláudio", avatar: "https://attachments.clickup.com/profilePictures/90763054_GfU.jpg" }, { id: 188529441, name: "DayGraph", avatar: "https://attachments.clickup.com/profilePictures/188529441_WRr.jpg" },
                { id: 194482086, name: "Lucas Rodrigues", avatar: null }, { id: 212437679, name: "Videomaker do Futuro", avatar: "https://attachments.clickup.com/profilePictures/212437679_Uyv.jpg" },
                { id: 212521614, name: "Vinícius Lopes", avatar: "https://attachments.clickup.com/profilePictures/212521614_8Lg.jpg" }
            ],
            PRIORITIES: [
                { id: '1', name: 'Urgente', color: '#d33d44' }, { id: '2', name: 'Alta', color: '#e16b16' },
                { id: '3', name: 'Normal', color: '#3E63DD' }, { id: '4', name: 'Baixa', color: '#87909e' }
            ],
            TAGS: [
                { name: "história", color: "#e5484d" }, { name: "realizada", color: "#3E63DD" }, { name: "movimento", color: "#0091FF" },
                { name: "brincadeiras", color: "#e93d82" }, { name: "agendada", color: "#f76808" }, { name: "site", color: "#248F7D" },
                { name: "esporte", color: "#AB4ABA" }, { name: "destaques", color: "#A18072" }, { name: "miniatura", color: "#23CB27" },
                { name: "feed", color: "#6E56CF" }, { name: "telegrama", color: "#248F7D" }, { name: "premiação", color: "#6E56CF" },
                { name: "diário", color: "#6E56CF" }, { name: "institucional", color: "#3E63DD" }, { name: "animação", color: "#000000" },
                { name: "casa", color: "#2F8960" }, { name: "vfx", color: "#2A7552" }, { name: "youtube", color: "#12A594" }
            ]
        };

        let currentUser = null;
        let currentDate = new Date();
        let tasks = [];
        let currentEditingTaskId = null;
        let tomSelectInstances = {};
        let popoverTimeout;
        let realtimeChannel = null;

        const authView = document.getElementById('auth-view'); const calendarView = document.getElementById('calendar-view'); const loginContainer = document.getElementById('login-container'); const signupContainer = document.getElementById('signup-container'); const loginForm = document.getElementById('login-form'); const signupForm = document.getElementById('signup-form'); const authError = document.getElementById('auth-error'); const userEmailEl = document.getElementById('user-email'); const monthYearEl = document.getElementById('month-year'); const calendarBodyEl = document.getElementById('calendar-body'); const modal = document.getElementById('post-modal'); const modalTitle = document.getElementById('modal-title'); const postForm = document.getElementById('post-form'); const postAttachmentInput = document.getElementById('post-attachment'); const deleteBtn = document.getElementById('delete-post-btn'); const saveBtn = document.getElementById('save-btn');
        const taskPopover = document.getElementById('task-popover');
        
        // --- Lógica Principal da Aplicação ---
        supabase.auth.onAuthStateChange((event, session) => { 
            if (session && session.user) { 
                currentUser = session.user; userEmailEl.textContent = currentUser.email; 
                authView.classList.add('hidden'); calendarView.classList.remove('hidden'); 
                initializeApp(); 
            } else { 
                currentUser = null; authView.classList.remove('hidden'); calendarView.classList.add('hidden'); 
                if(realtimeChannel) { supabase.removeChannel(realtimeChannel); } 
            } 
        });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); authError.textContent = ''; const btn = loginForm.querySelector('button[type=submit]'); btn.disabled = true; btn.textContent = 'Aguarde...'; try { const { error } = await supabase.auth.signInWithPassword({ email: loginForm.email.value, password: loginForm.password.value }); if (error) authError.textContent = 'Email ou senha inválidos.'; } finally { btn.disabled = false; btn.textContent = 'ENTRAR'; } });
        signupForm.addEventListener('submit', async (e) => { e.preventDefault(); authError.textContent = ''; const btn = signupForm.querySelector('button[type=submit]'); btn.disabled = true; btn.textContent = 'Aguarde...'; try { const { error } = await supabase.auth.signUp({ email: signupForm.email.value, password: signupForm.password.value }); if (error) { authError.textContent = error.message; } else { authError.textContent = 'Verifique seu email para confirmar a conta!'; } } finally { btn.disabled = false; btn.textContent = 'CRIAR CONTA'; } });
        document.getElementById('logout-btn').addEventListener('click', () => supabase.auth.signOut()); document.getElementById('show-signup').addEventListener('click', () => { loginContainer.classList.add('hidden'); signupContainer.classList.remove('hidden'); }); document.getElementById('show-login').addEventListener('click', () => { signupContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); });

        async function initializeApp() { 
            if (!currentUser) return; 
            initializeTomSelects(); 
            await fetchAndRenderAll();
            listenForRealtimeUpdates();
        }

        function listenForRealtimeUpdates() {
            if (realtimeChannel) { supabase.removeChannel(realtimeChannel); }
            realtimeChannel = supabase.channel('task-updates');
            realtimeChannel.on('broadcast', { event: 'taskUpdated' }, async ({ payload }) => {
                const updatedTask = await getSingleClickUpTask(payload.task_id);
                if (updatedTask) {
                    const index = tasks.findIndex(t => t.id === payload.task_id);
                    const taskDate = new Date(parseInt(updatedTask.due_date));
                    const taskIsInCurrentMonth = taskDate.getMonth() === currentDate.getMonth() && taskDate.getFullYear() === currentDate.getFullYear();
                    if (index !== -1) {
                        if (taskIsInCurrentMonth) { tasks[index] = updatedTask; } 
                        else { tasks.splice(index, 1); }
                    } else if (taskIsInCurrentMonth) {
                        tasks.push(updatedTask);
                    }
                    renderCalendar();
                    renderFeedPreview();
                }
            }).subscribe();
        }

        async function fetchAndRenderAll() { 
            const summarizedTasks = await getClickUpTasks();
            tasks = await enrichTasksWithDetails(summarizedTasks);
            renderCalendar(); 
            renderFeedPreview(); 
        }

        async function enrichTasksWithDetails(tasksToEnrich) {
            const promises = tasksToEnrich.map(task => {
                if (task.status?.id === CLICKUP_CONFIG.STATUS_ORG_DRIVE) {
                    return getSingleClickUpTask(task.id);
                }
                return Promise.resolve(task);
            });
            return Promise.all(promises);
        }
        
        function initializeTomSelects() {
            if (Object.keys(tomSelectInstances).length > 0) return; 
            tomSelectInstances.status = new TomSelect('#post-status', { options: CLICKUP_CONFIG.STATUSES.map(s => ({ value: s.id, text: s.name, color: s.color })), render: { option: (data, escape) => `<div class="flex items-center"><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${escape(data.color)}; margin-right: 8px;"></span><span style="color: white;">${escape(data.text)}</span></div>`, item: (data, escape) => `<div class="flex items-center"><span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${escape(data.color)}; margin-right: 8px;"></span><span style="color: white;">${escape(data.text)}</span></div>` } });
            tomSelectInstances.assignees = new TomSelect('#post-assignees', { options: CLICKUP_CONFIG.USERS.map(u => ({ value: u.id, text: u.name, avatar: u.avatar })), render: { option: (data, escape) => { const avatarUrl = data.avatar || `https://ui-avatars.com/api/?name=${escape(data.text)}&background=065359&color=fff`; return `<div class="flex items-center"><img class="assignee-option-avatar" src="${avatarUrl}" alt=""><span style="color: white;">${escape(data.text)}</span></div>`; }, item: (data, escape) => { const avatarUrl = data.avatar || `https://ui-avatars.com/api/?name=${escape(data.text)}&background=065359&color=fff`; return `<div class="flex items-center"><img class="assignee-item-avatar" src="${avatarUrl}" alt=""><span style="color: white;">${escape(data.text)}</span></div>`; } } });
            tomSelectInstances.priority = new TomSelect('#post-priority', { options: CLICKUP_CONFIG.PRIORITIES.map(p => ({ value: p.id, text: p.name, color: p.color })), render: { option: (data, escape) => `<div class="flex items-center"><svg class="inline-block mr-2" width="12" height="12" viewBox="0 0 24 24" fill="${escape(data.color)}"><path d="M4 24h-2v-24h2v24zm18-16.632l-10 4.632v-7l10-5v7.368z"/></svg><span style="color: white;">${escape(data.text)}</span></div>`, item: (data, escape) => `<div class="flex items-center"><svg class="inline-block mr-2" width="12" height="12" viewBox="0 0 24 24" fill="${escape(data.color)}"><path d="M4 24h-2v-24h2v24zm18-16.632l-10 4.632v-7l10-5v7.368z"/></svg><span style="color: white;">${escape(data.text)}</span></div>` } });
            tomSelectInstances.tags = new TomSelect('#post-tags', { options: CLICKUP_CONFIG.TAGS.map(t => ({ value: t.name, text: t.name, color: t.color })), create: true, plugins: ['remove_button'], render: { option: (data, escape) => { const color = data.color || '#718096'; return `<div class="py-1"><span style="background-color: ${escape(color)}; color: white; padding: 3px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 500;">${escape(data.text)}</span></div>`; }, item: (data, escape) => { const tagData = CLICKUP_CONFIG.TAGS.find(t => t.name.toLowerCase() === data.text.toLowerCase()); const color = tagData ? tagData.color : '#718096'; return `<div class="ts-item" style="background-color: ${escape(color)} !important; color: white !important; text-shadow: 0 1px 1px rgba(0,0,0,0.2);">${escape(data.text)}</div>`; } } });
        }
        
        async function clickupFetch(endpoint, options = {}) { const response = await fetch('/api/clickup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ endpoint, method: options.method || 'GET', body: options.body || null }) }); if (!response.ok) { const err = await response.json(); throw new Error(err.err || 'Erro desconhecido'); } return response.json(); }
        async function getClickUpTasks() { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const firstDay = new Date(year, month, 1).getTime(); const lastDay = new Date(year, month + 1, 1).getTime(); const endpoint = `list/${CLICKUP_CONFIG.LIST_ID}/task?subtasks=true&due_date_gt=${firstDay}&due_date_lt=${lastDay}&tags[]=${CLICKUP_CONFIG.APP_TAG}`; try { const data = await clickupFetch(endpoint); return data.tasks || []; } catch (error) { console.error(`Erro ao buscar tarefas do ClickUp: ${error.message}`); return []; } }
        async function getSingleClickUpTask(taskId) { try { return await clickupFetch(`task/${taskId}?subtasks=true`); } catch (error) { console.error(`Failed to fetch task ${taskId}:`, error); return null; } }
        async function createClickUpTask(taskData) { return clickupFetch(`list/${CLICKUP_CONFIG.LIST_ID}/task`, { method: 'POST', body: taskData }); }
        async function updateClickUpTask(taskId, taskData) { return clickupFetch(`task/${taskId}`, { method: 'PUT', body: taskData }); }

        function renderCalendar() { /* ...código de renderização... */ }
        function createDayCell(day) { /* ...código de renderização... */ }
        function createTaskElement(task) { /* ...código de renderização... */ }
        function renderFeedPreview() { /* ...código de renderização... */ }
        function showTaskDetails(event, task) { /* ...código do popover... */ }
        function hideTaskDetails() { /* ...código do popover... */ }
        taskPopover.addEventListener('mouseenter', () => clearTimeout(popoverTimeout));
        taskPopover.addEventListener('mouseleave', hideTaskDetails);

        async function openModal(dateStr, taskId = null) { /* ...código do modal... */ }
        function closeModal() { /* ...código do modal... */ }
        
        // CORRIGIDO: Nova função de Salvar Tarefa com lógica "Otimista"
        function handleFormSubmit(e) {
            e.preventDefault();

            // --- ATUALIZAÇÃO OTIMISTA IMEDIATA ---
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';

            const taskDataForUI = {
                id: currentEditingTaskId || `temp_${Date.now()}`,
                name: postTitleInput.value,
                due_date: new Date(postDateInput.value + 'T12:00:00Z').getTime().toString(),
                status: { id: tomSelectInstances.status.getValue(), color: CLICKUP_CONFIG.STATUSES.find(s => s.id === tomSelectInstances.status.getValue())?.color },
                // Adicionamos dados básicos para a UI funcionar imediatamente
                assignees: [], 
                tags: [],
                priority: null
            };

            if (currentEditingTaskId) {
                const index = tasks.findIndex(t => t.id === currentEditingTaskId);
                if (index !== -1) tasks[index] = { ...tasks[index], ...taskDataForUI };
            } else {
                tasks.push(taskDataForUI);
            }
            renderCalendar();
            closeModal();
            
            // --- OPERAÇÕES DE BACKEND EM SEGUNDO PLANO ---
            (async () => {
                try {
                    let description = postDescriptionInput.value;
                    const originalDescription = postDescriptionInput.value;
                    const attachmentFile = postAttachmentInput.files[0];

                    if (attachmentFile) {
                        const filePath = `public/${currentUser.id}/${Date.now()}_${attachmentFile.name}`;
                        const { error: uploadError } = await supabase.storage.from('attachments').upload(filePath, attachmentFile);
                        if (uploadError) throw new Error(`Falha no upload para Supabase: ${uploadError.message}`);
                        
                        const { data: urlData } = supabase.storage.from('attachments').getPublicUrl(filePath);
                        const attachmentLink = `\n\n--- \nAnexo: [${attachmentFile.name}](${urlData.publicUrl})`;
                        description += attachmentLink;
                    }

                    const assignees = tomSelectInstances.assignees.getValue();
                    const tags = tomSelectInstances.tags.getValue();
                    if (!tags.includes(CLICKUP_CONFIG.APP_TAG)) { tags.push(CLICKUP_CONFIG.APP_TAG); }
                    const statusId = tomSelectInstances.status.getValue();
                    const statusName = CLICKUP_CONFIG.STATUSES.find(s => s.id === statusId)?.name;

                    const taskDataForApi = { 
                        name: postTitleInput.value, 
                        description: attachmentFile ? description : originalDescription,
                        status: statusName, 
                        priority: parseInt(tomSelectInstances.priority.getValue()), 
                        assignees: assignees, 
                        tags: tags, 
                        due_date: new Date(postDateInput.value + 'T12:00:00Z').getTime(), 
                    };

                    let savedTask;
                    if (currentEditingTaskId) {
                        savedTask = await updateClickUpTask(currentEditingTaskId, taskDataForApi);
                    } else {
                        savedTask = await createClickUpTask(taskDataForApi);
                    }

                    // Sincroniza a UI com os dados reais do ClickUp
                    const finalTask = await getSingleClickUpTask(savedTask.id);
                    if (finalTask) {
                        const index = tasks.findIndex(t => t.id === taskDataForUI.id); // Procura pelo ID temporário ou real
                        if (index !== -1) tasks[index] = finalTask;
                        renderCalendar();
                        renderFeedPreview();
                    }

                } catch (error) {
                    console.error('Falha na sincronização em segundo plano:', error);
                    alert(`A tarefa foi atualizada na tela, mas falhou ao salvar no ClickUp: ${error.message}`);
                    // Opcional: remover a tarefa da UI se a criação falhar
                    if (!currentEditingTaskId) {
                        const index = tasks.findIndex(t => t.id === taskDataForUI.id);
                        if (index !== -1) tasks.splice(index, 1);
                        renderCalendar();
                    }
                } finally {
                    // Este bloco agora é menos crítico, pois o modal já fechou
                    console.log('Sincronização em segundo plano concluída.');
                }
            })();
        }
        
        document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); fetchAndRenderAll(); });
        document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); fetchAndRenderAll(); });
        document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); fetchAndRenderAll(); });
        document.getElementById('cancel-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        postForm.addEventListener('submit', handleFormSubmit);

    </script>
</body>
</html>
